<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Protocol: OMEGA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-dark: #0a0a0f; }
        body { background-color: var(--bg-dark); color: #e0e0e0; font-family: 'Courier New', Courier, monospace; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        .crt-overlay { background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%; pointer-events: none; }
        .slot { transition: all 0.3s ease; box-shadow: inset 0 0 10px rgba(0,0,0,0.8); }
        .slot.active { border-color: #00f3ff; box-shadow: 0 0 15px #00f3ff; }
        .item.selected { border-color: #39ff14; box-shadow: 0 0 10px #39ff14; background-color: rgba(57, 255, 20, 0.1); }
        .item.placed { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
        .glitch-text { animation: glitch 2s infinite; text-shadow: 2px 2px #ff073a; }
        @keyframes glitch { 0%, 100% { transform: translate(0) } 20% { transform: translate(-2px, 2px) } 40% { transform: translate(-2px, -2px) } 60% { transform: translate(2px, 2px) } 80% { transform: translate(2px, -2px) } }
        @keyframes shake { 0%, 100% { transform: translate(0,0) } 10%, 30%, 50%, 70%, 90% { transform: translate(-2px, -1px) } 20%, 40%, 60%, 80% { transform: translate(2px, 1px) } }
        .shake { animation: shake 0.5s infinite; }
        .danger-bg { background-color: #2a0a0a; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-between p-4 relative overflow-hidden" id="game-body">
    <div class="crt-overlay fixed inset-0 z-50 pointer-events-none"></div>

    <header class="w-full max-w-lg flex flex-col gap-2 z-10">
        <div class="flex justify-between items-end border-b-2 border-green-500 pb-2">
            <h1 class="text-2xl font-bold text-green-500 glitch-text tracking-widest">PROTOCOL: OMEGA</h1>
            <div id="timer-display" class="text-3xl font-mono text-red-500 font-bold">45.00</div>
        </div>
        <div class="w-full h-2 bg-gray-800 rounded overflow-hidden"><div id="timer-bar" class="h-full bg-red-600 w-full transition-all duration-100"></div></div>
    </header>

    <main id="game-screen" class="flex-1 w-full max-w-lg flex flex-col gap-4 py-4 z-10">
        <div class="bg-gray-900 border border-orange-800 p-2 rounded shadow-lg flex items-center justify-between gap-4">
            <div class="flex-1">
                <div class="flex justify-between text-xs text-orange-500 mb-1 uppercase font-bold tracking-widest"><span>Reactor Flux</span><span id="instability-text">0%</span></div>
                <div class="w-full h-4 bg-gray-800 rounded overflow-hidden border border-orange-900"><div id="instability-bar" class="h-full bg-orange-500 w-0 transition-all duration-75"></div></div>
            </div>
            <button onclick="purgeHeat()" class="bg-orange-900 hover:bg-orange-700 text-orange-100 text-xs font-bold px-4 py-3 rounded border border-orange-600 active:scale-95 transition-all uppercase tracking-wider touch-manipulation"><i class="fa-solid fa-fan animate-spin"></i> Purge</button>
        </div>
        <div class="bg-gray-900 border border-green-800 p-4 rounded text-sm md:text-base shadow-lg"><h3 class="text-green-400 font-bold mb-2 border-b border-green-900 inline-block">BLUEPRINT LOGIC:</h3><ul id="clue-list" class="space-y-2 text-gray-300 font-mono list-disc pl-4"><li>Initializing...</li></ul></div>
        <div class="flex flex-col gap-2"><div class="text-xs text-center text-gray-500 tracking-widest">ASSEMBLY SEQUENCE</div><div class="grid grid-cols-5 gap-2 h-20 md:h-24" id="slots-container"></div></div>
        <div class="flex-1 flex flex-col justify-end"><div class="text-xs text-center text-gray-500 mb-2 tracking-widest">AVAILABLE COMPONENTS</div><div id="inventory" class="grid grid-cols-5 gap-2"></div></div>
        <button onclick="checkSolution()" class="w-full bg-green-900 hover:bg-green-700 text-green-100 font-bold py-4 rounded border border-green-500 shadow-[0_0_15px_rgba(0,255,0,0.3)] transition-all active:scale-95 uppercase tracking-widest mt-2 touch-manipulation"><i class="fa-solid fa-power-off mr-2"></i> Initiate Sequence</button>
    </main>

    <div id="result-screen" class="hidden fixed inset-0 z-[60] bg-black flex flex-col items-center justify-center text-center p-6">
        <div id="result-icon" class="text-6xl mb-6"></div>
        <h2 id="result-title" class="text-3xl font-bold mb-2 uppercase"></h2>
        <p id="result-msg" class="text-gray-400 mb-8 font-mono max-w-md"></p>
        <!-- Status Message for Admin Logging -->
        <div id="admin-status" class="text-xs text-yellow-500 font-mono mb-4 border border-yellow-900 p-2 rounded bg-black"></div>
        <button onclick="startGame()" class="px-8 py-3 bg-white text-black font-bold rounded hover:bg-gray-300 touch-manipulation">REBOOT SYSTEM</button>
    </div>

    <div id="start-screen" class="fixed inset-0 z-[70] bg-gray-900 flex flex-col items-center justify-center text-center p-6">
        <i class="fa-solid fa-microchip text-green-500 text-6xl mb-6 animate-pulse"></i>
        <h1 class="text-4xl font-bold text-white mb-2 tracking-widest glitch-text">OMEGA BUILD</h1>
        <p class="text-gray-400 mb-8 max-w-md leading-relaxed">1. Assemble the 5 components.<br>2. PURGE heat to prevent meltdown.</p>
        <button id="start-btn" class="px-8 py-4 bg-green-600 text-white font-bold rounded shadow-[0_0_20px_rgba(0,255,0,0.5)] hover:bg-green-500 transition-all active:scale-95 touch-manipulation cursor-pointer">START ASSEMBLY</button>
    </div>

    <script>
        // Init Telegram
        let tg = null;
        try { if(window.Telegram && window.Telegram.WebApp) { tg = window.Telegram.WebApp; tg.ready(); tg.expand(); tg.setHeaderColor('#0a0a0f'); tg.setBackgroundColor('#0a0a0f'); } } catch(e){}

        const COMPONENTS = [
            { id: 'core', name: 'Quantum Core', icon: 'fa-atom', color: 'text-purple-400', border: 'border-purple-500' },
            { id: 'chip', name: 'Logic Chip', icon: 'fa-microchip', color: 'text-blue-400', border: 'border-blue-500' },
            { id: 'flux', name: 'Flux Emitter', icon: 'fa-bolt', color: 'text-yellow-400', border: 'border-yellow-500' },
            { id: 'timer', name: 'Chronometer', icon: 'fa-clock', color: 'text-red-400', border: 'border-red-500' },
            { id: 'plasma', name: 'Plasma Cell', icon: 'fa-dna', color: 'text-pink-400', border: 'border-pink-500' }
        ];

        let timer = 45, instability = 0, gameInterval, solution = [], placedItems = [null,null,null,null,null], selectedComponent = null;

        // UI Refs
        const els = {
            timer: document.getElementById('timer-display'),
            bar: document.getElementById('timer-bar'),
            fluxBar: document.getElementById('instability-bar'),
            fluxText: document.getElementById('instability-text'),
            body: document.getElementById('game-body'),
            inv: document.getElementById('inventory'),
            slots: document.getElementById('slots-container'),
            clues: document.getElementById('clue-list'),
            result: document.getElementById('result-screen'),
            start: document.getElementById('start-screen'),
            adminStatus: document.getElementById('admin-status')
        };

        document.getElementById('start-btn').addEventListener('click', startGame);

        function startGame() {
            els.start.classList.add('hidden');
            els.result.classList.add('hidden');
            placedItems = [null,null,null,null,null];
            selectedComponent = null;
            timer = 45;
            instability = 0;
            els.body.className = "h-screen w-screen flex flex-col items-center justify-between p-4 relative overflow-hidden";
            generatePuzzle();
            render();
            if(gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, 100);
        }

        function gameLoop() {
            timer -= 0.1;
            instability += 0.4;
            updateUI();
            if(timer <= 0) endGame(false, "TIME EXPIRED");
            else if(instability >= 100) endGame(false, "REACTOR MELTDOWN");
        }

        function updateUI() {
            els.timer.textContent = Math.max(0, timer).toFixed(2);
            els.bar.style.width = `${(timer/45)*100}%`;
            instability = Math.min(100, Math.max(0, instability));
            els.fluxBar.style.width = `${instability}%`;
            els.fluxText.textContent = Math.floor(instability) + "%";
            
            if(instability > 75) {
                els.body.classList.add('shake', 'danger-bg');
                els.fluxBar.classList.replace('bg-orange-500', 'bg-red-500');
            } else {
                els.body.classList.remove('shake', 'danger-bg');
                els.fluxBar.classList.replace('bg-red-500', 'bg-orange-500');
            }
        }

        window.purgeHeat = () => { if(timer > 0) instability -= 20; updateUI(); };

        function generatePuzzle() {
            let shuffled = [...COMPONENTS].sort(() => Math.random() - 0.5);
            solution = shuffled.map(c => c.id);
            const getName = (id) => COMPONENTS.find(c => c.id === id).name;
            const clues = [
                `The <span class="text-green-400 font-bold">${getName(solution[0])}</span> is in slot I.`,
                `The <span class="text-green-400 font-bold">${getName(solution[1])}</span> is next to the <span class="text-green-400 font-bold">${getName(solution[0])}</span>.`,
                `The <span class="text-green-400 font-bold">${getName(solution[4])}</span> is in slot V.`,
                `The <span class="text-green-400 font-bold">${getName(solution[2])}</span> is before the <span class="text-green-400 font-bold">${getName(solution[3])}</span>.`
            ].sort(() => Math.random() - 0.5);
            els.clues.innerHTML = clues.map(c => `<li class="leading-relaxed border-l-2 border-gray-700 pl-2 mb-2">${c}</li>`).join('');
        }

        function render() {
            // Inventory
            els.inv.innerHTML = COMPONENTS.map(c => {
                const placed = placedItems.includes(c.id);
                const sel = selectedComponent?.id === c.id;
                return `<div class="item border ${c.border} bg-gray-900 rounded p-1 flex flex-col items-center justify-center h-20 ${placed?'placed':''} ${sel?'selected':''}" onclick="select('${c.id}')"><i class="fa-solid ${c.icon} ${c.color} text-2xl"></i><span class="text-[0.6rem] uppercase tracking-wider text-gray-400">${c.name}</span></div>`
            }).join('');
            
            // Slots
            els.slots.innerHTML = placedItems.map((pid, i) => {
                const c = pid ? COMPONENTS.find(x => x.id === pid) : null;
                const active = selectedComponent && !pid ? 'active border-green-500' : 'border-gray-600';
                return `<div class="slot border-2 border-dashed rounded bg-black/50 flex items-center justify-center relative cursor-pointer ${active}" onclick="slotClick(${i})"><span class="absolute top-1 left-2 text-xs text-gray-600 font-bold">${['I','II','III','IV','V'][i]}</span><div class="text-3xl text-gray-700">${c ? `<i class="fa-solid ${c.icon} ${c.color}"></i>` : '<i class="fa-solid fa-plus"></i>'}</div></div>`
            }).join('');
        }

        window.select = (id) => {
            if(!placedItems.includes(id)) selectedComponent = selectedComponent?.id === id ? null : COMPONENTS.find(c => c.id === id);
            render();
        };

        window.slotClick = (i) => {
            if(selectedComponent) { placedItems[i] = selectedComponent.id; selectedComponent = null; }
            else placedItems[i] = null;
            render();
        };

        window.checkSolution = () => {
            if(placedItems.includes(null)) return alert("FILL ALL SLOTS");
            clearInterval(gameInterval);
            const win = placedItems.every((val, i) => val === solution[i]);
            endGame(win, win ? "SEQUENCE VERIFIED" : "SEQUENCE FAILED");
        };

        function endGame(win, msg) {
            clearInterval(gameInterval);
            els.body.className = "h-screen w-screen flex flex-col items-center justify-between p-4 relative overflow-hidden";
            els.result.classList.remove('hidden');
            
            document.getElementById('result-title').textContent = win ? "MISSION ACCOMPLISHED" : "MISSION FAILED";
            document.getElementById('result-title').className = win ? "text-3xl font-bold mb-2 uppercase text-green-500" : "text-3xl font-bold mb-2 uppercase text-red-500";
            document.getElementById('result-msg').textContent = msg;
            document.getElementById('result-icon').innerHTML = win ? '<i class="fa-solid fa-check-circle text-green-500"></i>' : '<i class="fa-solid fa-bomb text-red-600"></i>';

            sendResultToAdmin(win);
        }

        async function sendResultToAdmin(isWin) {
            const statusEl = els.adminStatus;
            statusEl.innerHTML = "<i class='fa-solid fa-spinner animate-spin'></i> Transmitting logs...";

            // 1. Get User Data or use Anonymous fallback
            let userData = {
                userId: 0,
                username: "Anonymous",
                firstName: "Unknown Agent"
            };

            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                userData = tg.initDataUnsafe.user;
            } else {
                console.warn("No Telegram User detected. Using Anonymous mode.");
            }

            try {
                // 2. Send to Vercel Backend
                const response = await fetch('/api/submit-score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userData.id || 0,
                        username: userData.username || 'Hidden',
                        firstName: userData.first_name || 'Agent',
                        outcome: isWin ? "WIN" : "LOSS"
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    statusEl.innerHTML = "<i class='fa-solid fa-check text-green-500'></i> Log Sent to HQ";
                    statusEl.className = "text-xs text-green-500 font-mono mb-4 border border-green-900 p-2 rounded bg-black";
                } else {
                    console.error("Backend Error:", result);
                    statusEl.innerHTML = `<i class='fa-solid fa-triangle-exclamation text-red-500'></i> Server Error: ${result.error || 'Unknown'}`;
                }
            } catch (err) {
                console.error("Network Error:", err);
                statusEl.innerHTML = "<i class='fa-solid fa-wifi text-red-500'></i> Connection Failed. Check Console.";
            }
        }
    </script>
</body>
</html>
